---
phase: 06-api-ownership-guardrails
plan: 02
type: execute
wave: 2
depends_on: ['06-01']
files_modified:
  - pages/api/vehicles/index.ts
  - pages/api/vehicles/[id].ts
  - pages/api/vehicles/[id]/statistics.ts
autonomous: true

must_haves:
  truths:
    - 'Unauthenticated calls to vehicles and vehicle statistics endpoints return a consistent 401 error envelope'
    - 'Vehicle list and create operations are scoped to the signed-in user and cannot spoof ownership'
    - 'Non-owner vehicle GET-by-id and statistics GET-by-id return 403 with generic not-found wording'
    - 'Non-owner vehicle PUT/DELETE are rejected with 403 and do not change data'
  artifacts:
    - path: 'pages/api/vehicles/index.ts'
      provides: 'Authenticated, ownership-scoped vehicle list/create endpoint'
      exports: ['default']
    - path: 'pages/api/vehicles/[id].ts'
      provides: 'Authenticated, owner-guarded vehicle detail/update/delete endpoint'
      exports: ['default']
    - path: 'pages/api/vehicles/[id]/statistics.ts'
      provides: 'Owner-guarded statistics endpoint aligned with GET-by-id policy'
      exports: ['default']
  key_links:
    - from: 'pages/api/vehicles/index.ts'
      to: 'pages/api/_shared/auth.ts'
      via: 'requireSessionUserId'
      pattern: 'requireSessionUserId'
    - from: 'pages/api/vehicles/[id].ts'
      to: 'pages/api/_shared/ownership.ts'
      via: 'ensureOwnedVehicle before reads/writes'
      pattern: 'ensureOwnedVehicle'
    - from: 'pages/api/vehicles/[id]/statistics.ts'
      to: 'pages/api/_shared/errors.ts'
      via: '403 + NOT_FOUND cloak for non-owner GET-by-id'
      pattern: 'NOT_FOUND'
    - from: 'pages/api/vehicles/index.ts'
      to: 'pages/api/_shared/errors.ts'
      via: '401 envelope for unauthenticated requests'
      pattern: 'sendUnauthenticated'
    - from: 'pages/api/vehicles/[id].ts'
      to: 'pages/api/_shared/errors.ts'
      via: '403 FORBIDDEN for non-owner writes'
      pattern: 'sendForbidden'
---

<objective>
Harden vehicle and statistics API routes with strict auth and ownership enforcement.

Purpose: Close cross-user read/write gaps in vehicle resources while preserving locked response semantics.
Output: Refactored vehicle list/detail/statistics endpoints using shared guardrail helpers.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-api-ownership-guardrails/06-CONTEXT.md
@.planning/phases/06-api-ownership-guardrails/06-RESEARCH.md
@.planning/phases/06-api-ownership-guardrails/06-01-PLAN.md

@pages/api/vehicles/index.ts
@pages/api/vehicles/[id].ts
@pages/api/vehicles/[id]/statistics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor vehicle list/create endpoint to enforce session ownership</name>
  <files>pages/api/vehicles/index.ts</files>
  <action>
Refactor `pages/api/vehicles/index.ts` to use the shared auth/error helpers and enforce owner scoping for both methods:
- Require session for `GET` and `POST`; unauthenticated always returns shared `401` envelope
- `GET`: return only vehicles where `user_id = session user id` (silent filtering policy)
- `POST`: never trust client `user_id`; derive owner from session and explicitly map allowed fields
- Preserve existing switch-based method routing and 405 handling

Reject malformed payloads with existing 400 behavior where applicable, but keep 401/403 guardrail responses standardized through shared envelope helpers.
</action>
<verify>
Open `pages/api/vehicles/index.ts` and confirm:

- `requireSessionUserId` is called at the top of `GET` and `POST` branches
- `GET` query filters by `{ user_id: sessionUserId }`
- `POST` data uses `sessionUserId` for ownership and ignores any client-sent `user_id`
  Run `npm run build` to ensure no type/import errors.
  </verify>
  <done>Vehicle list/create are session-scoped and cannot be spoofed by client `user_id` input.</done>
  </task>

<task type="auto">
  <name>Task 2: Refactor vehicle detail endpoint with owner checks for GET/PUT/DELETE</name>
  <files>pages/api/vehicles/[id].ts</files>
  <action>
Refactor `pages/api/vehicles/[id].ts` to enforce auth + ownership in every method branch:
- Parse and validate `id` safely (400 on invalid id)
- Require session first
- `GET`: if vehicle not owned, return `403` with generic not-found wording via shared `NOT_FOUND` envelope
- `PUT`/`DELETE`: if vehicle not owned, return `403` with shared `FORBIDDEN` envelope
- Keep ownership guard checks before first write query to enforce strict no-op on failed ownership checks

Maintain explicit field mapping in updates and keep method switch + allow header conventions.
</action>
<verify>
Open `pages/api/vehicles/[id].ts` and confirm:

- `requireSessionUserId` runs before any Prisma query
- `ensureOwnedVehicle` (or equivalent) is checked before all writes
- `GET` uses `sendForbiddenAsNotFound` (or equivalent) for non-owner
- `PUT`/`DELETE` use `sendForbidden` for non-owner
  </verify>
  <done>Vehicle detail/update/delete are owner-guarded, with read cloaked as NOT_FOUND and write attempts blocked before mutations.</done>
  </task>

<task type="auto">
  <name>Task 3: Align statistics endpoint to the same owner-guarded GET-by-id policy</name>
  <files>pages/api/vehicles/[id]/statistics.ts</files>
  <action>
Update `pages/api/vehicles/[id]/statistics.ts` to match the exact guard behavior used by vehicle GET-by-id:
- Require session via shared auth helper
- Verify vehicle ownership before loading fueling rows
- On non-owner vehicle id, return `403` with generic not-found wording using shared `NOT_FOUND` envelope
- Keep existing successful statistics shape and year validation behavior

Do not change aggregation math in this phase; only harden access boundaries and response contract consistency.
</action>
<verify>
Open `pages/api/vehicles/[id]/statistics.ts` and confirm:

- `requireSessionUserId` gates access before statistics queries
- ownership check occurs before reading fuelings
- non-owner path returns NOT_FOUND envelope with 403 status
  </verify>
  <done>Statistics endpoint applies the same auth/ownership contract as vehicle GET-by-id without changing aggregation behavior.</done>
  </task>

</tasks>

<verification>
- `npm run build`
- Manual API matrix subset for vehicle/statistics endpoints (unauthenticated, owner, non-owner read, non-owner write)
</verification>

<success_criteria>

- Vehicle and statistics endpoints no longer allow cross-user access or mutation paths.
- Locked 401/403 envelope behavior is consistent across all vehicle-domain routes.
  </success_criteria>

<output>
After completion, create `.planning/phases/06-api-ownership-guardrails/06-02-SUMMARY.md`
</output>
