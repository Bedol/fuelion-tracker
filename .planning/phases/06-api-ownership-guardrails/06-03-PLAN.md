---
phase: 06-api-ownership-guardrails
plan: 03
type: execute
wave: 2
depends_on: ['06-01']
files_modified:
  - pages/api/fueling/index.ts
  - pages/api/fueling/[id].ts
  - hooks/useCreateFueling.ts
  - hooks/useUpdateFueling.ts
  - hooks/useDeleteFueling.ts
autonomous: true

must_haves:
  truths:
    - 'Unauthenticated fueling API calls return the same 401 error envelope as other guarded endpoints'
    - 'Fueling list and detail access are owner-scoped through vehicle ownership and do not leak cross-user data'
    - 'Cross-owner fueling create/update/delete attempts return 403 and perform no writes'
    - 'Fueling mutation hooks surface server envelope messages instead of generic failures when guardrails trigger'
  artifacts:
    - path: 'pages/api/fueling/index.ts'
      provides: 'Owner-scoped fueling list/create with cross-owner create rejection'
      exports: ['default']
    - path: 'pages/api/fueling/[id].ts'
      provides: 'Owner-guarded fueling detail/update/delete with strict no-op guards'
      exports: ['default']
    - path: 'hooks/useCreateFueling.ts'
      provides: 'Create mutation that reads standardized API error envelopes'
    - path: 'hooks/useUpdateFueling.ts'
      provides: 'Update mutation that reads standardized API error envelopes'
    - path: 'hooks/useDeleteFueling.ts'
      provides: 'Delete mutation that reads standardized API error envelopes'
  key_links:
    - from: 'pages/api/fueling/index.ts'
      to: 'pages/api/_shared/ownership.ts'
      via: 'owned vehicle check before create and list filtering'
      pattern: 'ensureOwnedVehicle'
    - from: 'pages/api/fueling/[id].ts'
      to: 'pages/api/_shared/ownership.ts'
      via: 'fueling ownership guard before read/write'
      pattern: 'ensureOwnedFueling'
    - from: 'hooks/useCreateFueling.ts'
      to: 'pages/api/fueling/index.ts'
      via: 'parsing `error.message` from standardized envelope'
      pattern: 'error\.message'
---

<objective>
Harden fueling APIs and align client mutation error handling with the shared guardrail envelope.

Purpose: Eliminate cross-user fueling access/mutation vectors and keep UI feedback coherent after server contract normalization.
Output: Refactored fueling routes with owner guards plus hook updates for standardized error parsing.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-api-ownership-guardrails/06-CONTEXT.md
@.planning/phases/06-api-ownership-guardrails/06-RESEARCH.md
@.planning/phases/06-api-ownership-guardrails/06-01-PLAN.md

@pages/api/fueling/index.ts
@pages/api/fueling/[id].ts
@hooks/useCreateFueling.ts
@hooks/useUpdateFueling.ts
@hooks/useDeleteFueling.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enforce ownership on fueling list/create endpoint</name>
  <files>pages/api/fueling/index.ts</files>
  <action>
Refactor `pages/api/fueling/index.ts` to use shared auth/error/ownership helpers:
- Require session for both methods; unauthenticated returns shared `401` envelope
- `GET`: keep list behavior as silent filtering by owner (no hard fail for foreign ids); include ownership relation filter in Prisma query
- `POST`: verify requested `vehicle_id` belongs to caller before any write; non-owner create returns `403 + FORBIDDEN`
- Ensure strict no-op for forbidden creates (no fueling row, no mileage side effects)

For successful create flows that write fueling + possible vehicle mileage update, use a transaction so dependent writes stay atomic.
</action>
<verify>Non-owner POST against foreign `vehicle_id` returns 403 and inserts zero rows; owner POST still returns 201 and updates mileage only when appropriate.</verify>
<done>Fueling list/create endpoint is owner-scoped and cannot create cross-user fuelings.</done>
</task>

<task type="auto">
  <name>Task 2: Enforce ownership on fueling detail update/delete endpoint</name>
  <files>pages/api/fueling/[id].ts</files>
  <action>
Refactor `pages/api/fueling/[id].ts` to enforce ownership for `GET`, `PUT`, and `DELETE` before any mutation query:
- Parse/validate id and require session using shared helpers
- `GET` on foreign fueling id returns `403 + NOT_FOUND` envelope with generic not-found wording
- `PUT`/`DELETE` on foreign id return `403 + FORBIDDEN` envelope
- Keep ownership checks before all writes to guarantee strict no-op on guard failures

Retain existing successful response contracts (`200` on GET/PUT, `204` on DELETE). For update flows that may also update vehicle mileage, keep write sequence atomic where dependent writes occur.
</action>
<verify>Foreign fueling id cannot be read/updated/deleted by another user; forbidden writes leave fueling and vehicle mileage unchanged.</verify>
<done>Fueling detail endpoint has no cross-user read/write path and obeys locked GET-vs-write status semantics.</done>
</task>

<task type="auto">
  <name>Task 3: Update fueling mutation hooks to parse standardized API error envelopes</name>
  <files>hooks/useCreateFueling.ts, hooks/useUpdateFueling.ts, hooks/useDeleteFueling.ts</files>
  <action>
Update mutation error parsing in all three hooks so they read the normalized server envelope (`error.message`) while preserving current fallback strings.

Implementation constraints:

- Keep hook signatures and invalidateQueries behavior unchanged
- Prefer a small shared parser inside each hook or a tiny local helper function to avoid duplicated unsafe casts
- Do not change success toasts or query keys in this phase

Goal is compatibility: when APIs return `401/403` envelope, toasts should show server-provided message instead of generic mutation failure.
</action>
<verify>Trigger a forbidden fueling mutation and confirm toast shows parsed API message; successful owner mutations still refresh fueling queries.</verify>
<done>Client mutation UX remains stable under the new guardrail error contract.</done>
</task>

</tasks>

<verification>
- `npm run build`
- Manual API matrix subset for fueling endpoints (unauthenticated, owner, non-owner read, non-owner create/update/delete)
</verification>

<success_criteria>

- Fueling endpoints enforce ownership for list/detail/create/update/delete with strict no-op on forbidden writes.
- Fueling mutation hooks correctly surface standardized server error messages.
  </success_criteria>

<output>
After completion, create `.planning/phases/06-api-ownership-guardrails/06-03-SUMMARY.md`
</output>
