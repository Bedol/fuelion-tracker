---
phase: 06-api-ownership-guardrails
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pages/api/_shared/auth.ts
  - pages/api/_shared/errors.ts
  - pages/api/_shared/ownership.ts
autonomous: true

must_haves:
  truths:
    - 'Protected API routes can enforce session identity through one shared guard function'
    - 'Auth and ownership failures can be returned through one standard JSON envelope with machine-readable codes'
    - 'Vehicle and fueling ownership checks are reusable and do not leak write side effects'
  artifacts:
    - path: 'pages/api/_shared/auth.ts'
      provides: 'Session guard helper that resolves authenticated user id or writes 401 envelope'
      exports: ['requireSessionUserId']
    - path: 'pages/api/_shared/errors.ts'
      provides: 'Unified API error envelope helpers for UNAUTHENTICATED/FORBIDDEN/NOT_FOUND'
      contains: 'sendApiError'
    - path: 'pages/api/_shared/ownership.ts'
      provides: 'Ownership guard helpers for vehicle and fueling resources'
      exports: ['ensureOwnedVehicle', 'ensureOwnedFueling']
  key_links:
    - from: 'pages/api/_shared/auth.ts'
      to: 'pages/api/auth/[...nextauth].ts'
      via: 'getServerSession(req,res,authOptions)'
      pattern: 'getServerSession'
    - from: 'pages/api/_shared/ownership.ts'
      to: 'lib/prisma.ts'
      via: 'owner-scoped Prisma queries'
      pattern: 'user_id'
---

<objective>
Create shared guardrail primitives for auth, error envelopes, and ownership checks.

Purpose: Centralize security-critical logic so all targeted endpoints enforce the same contract.
Output: Reusable API helpers under `pages/api/_shared/*` for session guard, error payloads, and ownership checks.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-api-ownership-guardrails/06-CONTEXT.md
@.planning/phases/06-api-ownership-guardrails/06-RESEARCH.md

@pages/api/auth/[...nextauth].ts
@lib/prisma.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shared auth guard and typed error envelope helpers</name>
  <files>pages/api/_shared/auth.ts, pages/api/_shared/errors.ts</files>
  <action>
Create `pages/api/_shared/errors.ts` with one standard envelope shape:
- `error.code` in `UNAUTHENTICATED | FORBIDDEN | NOT_FOUND`
- `error.message` in English
- optional safe `error.details`

Export helper functions that write consistent responses (for example `sendUnauthenticated`, `sendForbidden`, `sendForbiddenAsNotFound`, `sendApiError`) and keep status/code mapping aligned to phase locks:

- unauthenticated: `401 + UNAUTHENTICATED`
- non-owner GET-by-id cloak: `403 + NOT_FOUND` with generic not-found wording
- non-owner writes: `403 + FORBIDDEN`

Create `pages/api/_shared/auth.ts` with `requireSessionUserId(req, res)` using `getServerSession(req, res, authOptions)` from `pages/api/auth/[...nextauth].ts`:

- Return `number` user id when authenticated
- Otherwise call `sendUnauthenticated(res, 'Authentication required.')` (or equivalent) and return `null`
- Avoid throwing; helper should be safe to call as the first line of each method branch

Define an `ApiErrorEnvelope` type (or equivalent) in `errors.ts` so all helpers share a typed shape and status/code mapping stays consistent.
</action>
<verify>
Open `pages/api/_shared/errors.ts` and confirm exports include `sendApiError`, `sendUnauthenticated`, `sendForbidden`, and `sendForbiddenAsNotFound` with 401/403 mappings described above.
Open `pages/api/_shared/auth.ts` and confirm `requireSessionUserId` calls `getServerSession(req, res, authOptions)` and returns `number | null` while writing the 401 envelope on `null`.
</verify>
<done>Shared auth/error helper APIs exist, are typed, and encode the locked 401/403/NOT_FOUND envelope contract.</done>
</task>

<task type="auto">
  <name>Task 2: Add ownership guard helpers for vehicle and fueling resources</name>
  <files>pages/api/_shared/ownership.ts</files>
  <action>
Create ownership utilities in `pages/api/_shared/ownership.ts` that perform owner-scoped Prisma checks before mutations:
- `ensureOwnedVehicle(vehicleId, userId)` with owner filter `{ id: vehicleId, user_id: userId }`
- `ensureOwnedFueling(fuelingId, userId)` with relational owner filter through `vehicle.user_id`

Return only safe data needed by callers (ids and relation ids), not full records. Include helpers that support list filtering and cross-owner POST guard checks (e.g., vehicle ownership existence for fueling create) such as:

- a `getOwnedVehicleWhere(userId)` helper returning `{ user_id: userId }` filter
- a `getOwnedFuelingWhere(userId)` helper returning nested filter through `vehicle.user_id`

Do not mutate data in these helpers. They are read-only guards to preserve strict no-op guarantees on failed writes.
</action>
<verify>
Open `pages/api/_shared/ownership.ts` and confirm:

- `ensureOwnedVehicle` and `ensureOwnedFueling` query Prisma with owner-scoped filters only
- helpers return `null` for non-owned ids and minimal safe data for owned ids
- no mutations (`create`, `update`, `delete`) appear in this module
  </verify>
  <done>Reusable ownership checks exist for vehicles/fuelings, are read-only, and expose filters usable in list endpoints.</done>
  </task>

<task type="auto">
  <name>Task 3: Validate helper ergonomics for downstream route refactors</name>
  <files>pages/api/_shared/auth.ts, pages/api/_shared/errors.ts, pages/api/_shared/ownership.ts</files>
  <action>
Review helper signatures and adjust naming/return contracts so downstream plans can implement route logic without ad hoc branching.

Specifically ensure:

- auth helper can be called as first line in each method branch
- error helpers are explicit about status/code and support optional `details`
- ownership helpers expose enough data for guarded update/delete and for cross-owner fueling POST rejection

Keep this task internal to helper files; do not refactor target endpoints yet.
</action>
<verify>
Run `npm run build` and confirm no import/type errors reference `pages/api/_shared/*` helpers.
Quickly scan helper exports to ensure they are minimal and do not require caller-side branching to interpret success vs failure.
</verify>
<done>Helper contracts are stable and ready for direct consumption by vehicles/fueling/statistics route refactors.</done>
</task>

</tasks>

<verification>
- `npm run build`
</verification>

<success_criteria>

- Shared API guardrail modules exist and encode the phase-locked auth/ownership error contract.
- Downstream route plans can enforce ownership by composing helper calls, not reimplementing logic.
  </success_criteria>

<output>
After completion, create `.planning/phases/06-api-ownership-guardrails/06-01-SUMMARY.md`
</output>
