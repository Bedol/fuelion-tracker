---
phase: 03-fueling-records
plan: 06
type: execute
wave: 1
depends_on: []
files_modified: [pages/api/fueling/index.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - 'POST /api/fueling endpoint accepts request body and creates record without runtime errors'
    - 'Prisma database receives only valid fields (fuel_type_id, currency_id) not string fields (fuel_type, currency)'
  artifacts:
    - path: 'pages/api/fueling/index.ts'
      provides: 'POST handler for fueling creation'
      min_lines: 106
      fixed_lines: [58-71]
  key_links:
    - from: 'POST /api/fueling'
      to: 'Prisma.create()'
      via: 'fuelingData object'
      pattern: "prisma\\..*create\\(\\{\\s+data:\\s+fuelingData"
---

<objective>
Fix runtime error in POST fueling API where spread operator includes invalid database fields.

Purpose: Ensure fueling creation works correctly by passing only valid Prisma model fields to database operations.

Output: Fixed API endpoint that properly maps string fuel_type to integer fuel_type_id and handles currency_id.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-fueling-records/03-VERIFICATION.md
@.planning/phases/03-fueling-records/03-05-SUMMARY.md
@pages/api/fueling/index.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Fix spread operator to exclude invalid database fields</name>
  <files>pages/api/fueling/index.ts</files>
  <action>
    Modify handlePost function (lines 57-71) to fix the spread operator issue:

    **Current code (INCORRECT):**
    ```typescript
    const fuelingData = {
      ...data,  // ❌ This spreads ALL fields including invalid ones
      vehicle_id: Number(data.vehicle_id),
      cost: parseFloat(data.cost),
      quantity: parseFloat(data.quantity),
      mileage: parseFloat(data.mileage),
      cost_per_unit: data.cost_per_unit || parseFloat((parseFloat(data.cost) / parseFloat(data.quantity)).toFixed(3)),
      date: new Date(data.date),
      fuel_type_id: fuelTypeMap[data.fuel_type] || 1,  // ❌ But we already have ...data including fuel_type
      currency_id: 1, // Default currency - simplified for v1
    };
    ```

    **Fixed code:**
    ```typescript
    const fuelingData = {
      vehicle_id: Number(data.vehicle_id),
      cost: parseFloat(data.cost),
      quantity: parseFloat(data.quantity),
      mileage: parseFloat(data.mileage),
      cost_per_unit: data.cost_per_unit || parseFloat((parseFloat(data.cost) / parseFloat(data.quantity)).toFixed(3)),
      date: new Date(data.date),
      fuel_type_id: fuelTypeMap[data.fuel_type] || 1,  // ✅ No spread operator, only valid fields
      currency_id: 1, // ✅ Default currency - simplified for v1
      full_tank: data.full_tank !== undefined ? data.full_tank : true,  // ✅ Explicitly set default
    };
    ```

    **Key changes:**
    1. Remove spread operator `...data` - it incorrectly includes `fuel_type` (string) and `currency` (string) which don't exist in Prisma model
    2. Explicitly set each valid field that needs transformation
    3. Add explicit `full_tank` field (not in request body but in schema)
    4. Keep existing logic for vehicle mileage update and cost_per_unit calculation

    Reference existing code patterns from handlePost lines 57-71
    Error reason: VERIFICATION.md - "Runtime error: Prisma rejects fuel_type field"

  </action>
  <verify>
    1. Check file syntax: Ensure no TypeScript errors (file must still compile)
    2. Verify no spread operator: Confirm `...data` is removed
    3. Confirm only valid fields remain: vehicle_id, cost, quantity, mileage, cost_per_unit, date, fuel_type_id, currency_id, full_tank
  </verify>
  <done>
    POST endpoint creates fueling records without Prisma validation errors. The API correctly maps string fuel_type to integer fuel_type_id and only passes valid schema fields to the database.
  </done>
</task>

<task type="auto">
  <name>Verify fix with build and runtime check</name>
  <files>pages/api/fueling/index.ts</files>
  <action>
    Run build to ensure TypeScript compilation succeeds with no errors on modified file:

    ```bash
    npm run build
    ```

    Then start dev server and test POST endpoint:
    ```bash
    npm run dev
    ```
    - Navigate to /vehicles/[id]/fuelings/new
    - Fill form and submit
    - Verify success response (201)
    - Check database: Run `npx prisma studio` and verify fueling was created

  </action>
  <verify>
    - Build command returns 0 errors
    - No TypeScript errors in modified file
    - Can successfully create fueling record via POST endpoint
    - Database contains valid fueling record with correct fuel_type_id
  </verify>
  <done>
    Runtime error is fixed. POST endpoint successfully creates fueling records in the database with proper field mapping.
  </done>
</task>

</tasks>

<verification>
After fixing the spread operator, verify the following:
1. No TypeScript errors on build
2. POST /api/fueling endpoint returns 201 on valid request
3. Database record is created with correct fuel_type_id (int) and currency_id (int)
4. API handles edge cases: missing fields still return 400, invalid mileage still returns 400
</verification>

<success_criteria>

1. POST /api/fueling endpoint works without runtime errors
2. Prisma receives only valid database fields (no fuel_type string or currency string)
3. Build passes with 0 errors
4. Fueling records are successfully created in database with correct field types
5. Existing tests (add/edit/delete fueling) continue to work
   </success_criteria>

<output>
After completion, create `.planning/phases/03-fueling-records/03-06-SUMMARY.md` documenting the fix and verification results.
</output>
