---
phase: 03-fueling-records
plan: 03
type: execute
wave: 3
depends_on:
  - 03-01
  - 03-02
files_modified:
  - components/fueling/FuelingForm.tsx
  - components/fueling/FuelingList.tsx
  - components/fueling/FuelingListItem.tsx
  - components/fueling/FuelingDeleteModal.tsx
  - components/fueling/index.ts
autonomous: true

must_haves:
  truths:
    - 'FuelingForm has field order: Price → Liters → (calculated price) → Full tank toggle → Odometer → Date'
    - 'Price-per-liter updates live as user types in cost or quantity fields'
    - 'Form uses on-blur validation (validateOnChange: false)'
    - 'FuelingList shows monthly grouped fuelings with infinite scroll'
    - 'FuelingListItem displays date, cost, price-per-liter, and full/partial indicator'
    - 'FuelingDeleteModal follows confirmation pattern with explicit warning'
    - 'Partial tank fuelings have visual distinction (orange tint or border)'
  artifacts:
    - path: 'components/fueling/FuelingForm.tsx'
      provides: 'Create/edit form with live calculation and smart defaults'
      exports: ['FuelingForm']
      min_lines: 200
    - path: 'components/fueling/FuelingList.tsx'
      provides: 'Infinite scroll list with monthly grouping'
      exports: ['FuelingList']
      min_lines: 100
    - path: 'components/fueling/FuelingListItem.tsx'
      provides: 'Individual fueling record display'
      exports: ['FuelingListItem']
      min_lines: 50
    - path: 'components/fueling/FuelingDeleteModal.tsx'
      provides: 'Delete confirmation modal'
      exports: ['FuelingDeleteModal']
      min_lines: 80
    - path: 'components/fueling/index.ts'
      provides: 'Component exports'
      exports:
        ['FuelingForm', 'FuelingList', 'FuelingListItem', 'FuelingDeleteModal']
  key_links:
    - from: 'FuelingForm'
      to: 'useFuelingDraft, useLastFuelingData, useCreateFueling, useUpdateFueling'
      via: 'hook imports'
      pattern: 'import.*useFueling'
    - from: 'FuelingList'
      to: 'useFuelings'
      via: 'useInfiniteQuery'
      pattern: 'useFuelings.*vehicleId'
    - from: 'FuelingListItem'
      to: 'format from date-fns'
      via: 'date formatting'
      pattern: 'format.*parseISO'
---

<objective>
Create all fueling-related React components following the UX patterns from 03-CONTEXT.md and technical patterns from 03-RESEARCH.md.

Purpose: This plan builds the UI layer for Phase 3 - the form for creating/editing fuelings, the infinite scroll list with monthly grouping, individual list items, and the delete confirmation modal. These components use the hooks from Plan 02 and types from Plan 01.

Output: Five files in components/fueling/ directory with complete implementations.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-fueling-records/03-01-SUMMARY.md
@.planning/phases/03-fueling-records/03-02-SUMMARY.md
@components/vehicles/VehicleForm.tsx
@components/vehicles/DeleteVehicleModal.tsx
@types/fueling_types.ts
@types/vehicle_types.ts

**Locked decisions from 03-CONTEXT.md:**

- Field order: Price → Liters → Odometer
- Live price-per-liter calculation displayed as read-only
- On-blur validation (not on-change)
- Full/partial tank toggle near liters field, default to full
- Date picker with today's date pre-filled
- List: sort newest first, group by month
- Partial tank visual distinction (different color/style)
- Delete confirmation with explicit warning

**Technical patterns from 03-RESEARCH.md:**

- Formik with `validateOnChange: false, validateOnBlur: true`
- Live calculation via onChange handlers with `setFieldValue`
- `toFixed(3)` for price-per-liter to avoid floating point errors
- Infinite scroll with `useInView` from react-intersection-observer
- Monthly grouping with `date-fns` `format(date, 'MMMM yyyy')`
- `enableReinitialize: true` for edit forms

**Component patterns to follow:**

- VehicleForm.tsx: Formik useFormik pattern, Chakra FormControl, ButtonGroup
- DeleteVehicleModal.tsx: Dialog.Root, Portal, toaster notifications, useMutation

**Chakra UI v3 notes:**

- FormControl, FormLabel are NOT exported from @chakra-ui/react in v3
- Use Field component instead: `import { Field } from '@chakra-ui/react'`
- Field has Input as child, with label and helperText props
- Error state via `invalid` prop on Field
- Switch component: `import { Switch } from '@chakra-ui/react'` (root/namespace export issue)
- Button uses `loading` prop (not `isLoading`)
- Select uses native HTML select element with Chakra styling

**Chakra v3 Field pattern:**

```tsx
import { Field, Input } from '@chakra-ui/react';
<Field label='Total Cost' required invalid={!!error} errorText={error}>
	<Input name='cost' type='number' />
</Field>;
```

**Chakra v3 Switch pattern:**

```tsx
import { Switch } from '../ui/switch'; // May need custom component
// OR use native switch with Chakra styling
```

</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FuelingForm component</name>
  <files>components/fueling/FuelingForm.tsx</files>
  <action>
    Create `components/fueling/FuelingForm.tsx` - the create/edit form component:

    **Props interface:**
    ```typescript
    interface FuelingFormProps {
      vehicle: VehicleData; // From vehicle_types.ts
      initialData?: FuelingData; // For edit mode
      mode: 'create' | 'edit';
      onSubmitSuccess?: () => void; // Callback after success
    }
    ```

    **Key features:**
    1. **Formik setup:**
       - `validateOnChange: false, validateOnBlur: true`
       - `enableReinitialize: true`
       - Validation: cost > 0, quantity > 0, mileage > 0, mileage > last_odometer (if available)

    2. **Smart defaults (create mode):**
       - Check for draft first: `loadDraft()`
       - Date: `format(new Date(), 'yyyy-MM-dd')`
       - Fuel type: `lastFueling?.fuel_type || vehicle.fuel_type`
       - Last odometer: `lastFueling?.mileage || vehicle.mileage` (for hint)
       - Full tank: `true`

    3. **Edit mode initial values:**
       - Map FuelingData to FuelingFormValues
       - Format date as 'yyyy-MM-dd'
       - Convert numbers to strings for inputs

    4. **Live calculation:**
       - `handleCostChange`: update cost field, recalculate cost_per_unit if quantity > 0
       - `handleQuantityChange`: update quantity field, recalculate cost_per_unit
       - Use `parseFloat(value).toFixed(3)` and convert back to number

    5. **Field order (CRITICAL - from 03-CONTEXT.md):**
       - Total Price Paid * (number, step="0.01")
       - Liters * (number, step="0.01")
       - Price per Liter (read-only, calculated)
       - Full Tank toggle (Switch)
       - Odometer * (number, placeholder shows last value)
       - Date * (type="date")

    6. **Auto-save draft:**
       - Only in create mode
       - `useEffect` that calls `saveDraft(formik.values)` when formik.dirty
       - Clear draft on successful submit

    7. **Submit handling:**
       - Use appropriate mutation based on mode
       - On success: clear draft (if create), show toast, call onSubmitSuccess callback

    **Import requirements:**
    - Formik: `import { useFormik } from 'formik'`
    - Hooks: `import { useFuelingDraft, useLastFuelingData, useCreateFueling, useUpdateFueling } from '../../hooks'`
    - Types: `import { FuelingData, FuelingFormValues, VehicleData } from '../../types'`
    - Chakra: `import { Box, Button, ButtonGroup, Field, Input, Switch, Text } from '@chakra-ui/react'`
    - Date: `import { format } from 'date-fns'`
    - Other: `import { useEffect } from 'react'`

    **Chakra v3 specifics:**
    - Use Field component (not FormControl)
    - Switch may need custom import or use native HTML styled
    - Button uses `loading` prop (not `isLoading`)

    **File size estimate:** ~250 lines (complex form)

  </action>
  <verify>wc -l components/fueling/FuelingForm.tsx</verify>
  <done>FuelingForm.tsx exists with all form fields in correct order, live calculation, validation, draft persistence, and smart defaults</done>
</task>

<task type="auto">
  <name>Task 2: Create FuelingList and FuelingListItem components</name>
  <files>components/fueling/FuelingList.tsx, components/fueling/FuelingListItem.tsx</files>
  <action>
    Create the list components for displaying fuelings:

    **FuelingListItem.tsx** (presentational component):
    ```typescript
    interface FuelingListItemProps {
      fueling: FuelingData;
      onEdit?: () => void;
      onDelete?: () => void;
    }
    ```
    - Display: formatted date, cost with currency, price-per-liter, full/partial indicator
    - Visual distinction for partial tank: use orange/amber color scheme or dashed border
    - Actions: Edit button, Delete button (or menu)
    - Use `format(parseISO(fueling.date), 'MMM d, yyyy')` for date
    - Show cost as `${fueling.cost.toFixed(2)} PLN` (vehicle.currency)
    - Show price-per-liter as `${fueling.cost_per_unit.toFixed(3)} PLN/L`
    - Full tank indicator: green dot or checkmark, Partial: orange/amber indicator

    **FuelingList.tsx** (container with infinite scroll):
    ```typescript
    interface FuelingListProps {
      vehicleId: number;
      currency: string;
      onEdit: (fueling: FuelingData) => void;
      onDelete: (fueling: FuelingData) => void;
    }
    ```
    - Use `useFuelings(vehicleId)` hook
    - Use `useInView` from react-intersection-observer for infinite scroll trigger
    - Group fuelings by month using `date-fns`:
      ```typescript
      const grouped = useMemo(() => {
        const groups: Record<string, FuelingData[]> = {};
        fuelings.forEach(f => {
          const monthKey = format(parseISO(f.date), 'MMMM yyyy');
          if (!groups[monthKey]) groups[monthKey] = [];
          groups[monthKey].push(f);
        });
        return groups;
      }, [fuelings]);
      ```
    - Render month headers with `Heading size="sm"`
    - Render FuelingListItem for each fueling in month group
    - Loading states: show Loading component from components/ui/loading.tsx
    - Error state: show ErrorAlert component
    - Empty state: "No fuelings yet" with add button

    **Import requirements:**
    - `import { useInView } from 'react-intersection-observer'`
    - `import { format, parseISO } from 'date-fns'`
    - `import { Box, Heading, Text, VStack } from '@chakra-ui/react'`
    - `import { useMemo, useEffect } from 'react'`
    - Hooks and types as needed

    **File sizes:**
    - FuelingListItem: ~60 lines
    - FuelingList: ~100 lines

  </action>
  <verify>wc -l components/fueling/FuelingList.tsx components/fueling/FuelingListItem.tsx</verify>
  <done>Both list components exist with infinite scroll, monthly grouping, proper date formatting, and partial tank visual distinction</done>
</task>

<task type="auto">
  <name>Task 3: Create FuelingDeleteModal and component index</name>
  <files>components/fueling/FuelingDeleteModal.tsx, components/fueling/index.ts</files>
  <action>
    Create the delete confirmation modal and barrel export file:

    **FuelingDeleteModal.tsx:**
    Follow the pattern from DeleteVehicleModal.tsx exactly:
    ```typescript
    interface FuelingDeleteModalProps {
      isOpen: boolean;
      onClose: () => void;
      fueling: {
        id: number;
        date: string;
        cost: number;
      };
      currency: string;
      onDeleteSuccess: () => void;
    }
    ```
    - Use `useDeleteFueling()` hook
    - Dialog title: "Delete Fueling Record?"
    - Body text: "Are you sure you want to delete the fueling record from {date} ({cost} {currency})?"
    - Warning text: "This action cannot be undone. Vehicle statistics will be recalculated." (red color)
    - Buttons: Cancel (outline), Delete (red, loading state)
    - Success toast: "Fueling deleted"
    - Error toast: "Failed to delete"

    **Chakra v3 Dialog pattern:**
    ```tsx
    <Dialog.Root open={isOpen} onOpenChange={(details) => !details.open && onClose()}>
      <Portal>
        <Dialog.Backdrop />
        <Dialog.Positioner>
          <Dialog.Content>
            <Dialog.Header>
              <Dialog.Title>Delete Fueling Record?</Dialog.Title>
            </Dialog.Header>
            <Dialog.Body>
              {/* content */}
            </Dialog.Body>
            <Dialog.Footer>
              {/* buttons */}
            </Dialog.Footer>
          </Dialog.Content>
        </Dialog.Positioner>
      </Portal>
    </Dialog.Root>
    ```

    **index.ts** (barrel exports):
    ```typescript
    export { default as FuelingForm } from './FuelingForm';
    export { default as FuelingList } from './FuelingList';
    export { default as FuelingListItem } from './FuelingListItem';
    export { default as FuelingDeleteModal } from './FuelingDeleteModal';
    ```

    **Import requirements for modal:**
    - `import { Button, Dialog, Portal, Text } from '@chakra-ui/react'`
    - `import { useDeleteFueling } from '../../hooks'`
    - `import { toaster } from '../ui/toaster'`

    **File sizes:**
    - FuelingDeleteModal: ~90 lines
    - index.ts: ~4 lines

  </action>
  <verify>wc -l components/fueling/FuelingDeleteModal.tsx components/fueling/index.ts</verify>
  <done>FuelingDeleteModal exists with proper confirmation flow, and index.ts exports all 4 components</done>
</task>

</tasks>

<verification>
After completion:
1. Verify all 5 files exist in components/fueling/
2. Check imports reference correct paths (../../hooks, ../../types, ../ui/toaster)
3. Ensure FuelingForm has field order: Price → Liters → Odometer → Date
4. Verify FuelingList uses useInView hook for infinite scroll
5. Check that partial tank visual distinction is implemented
</verification>

<success_criteria>

- components/fueling/FuelingForm.tsx: Form component with live calculation, validation, draft persistence, smart defaults
- components/fueling/FuelingList.tsx: List with infinite scroll and monthly grouping
- components/fueling/FuelingListItem.tsx: Individual fueling display with full/partial indicator
- components/fueling/FuelingDeleteModal.tsx: Confirmation modal following project pattern
- components/fueling/index.ts: Barrel exports for all components
- All components use Chakra v3 patterns (Field instead of FormControl)
- All components follow form UX decisions from 03-CONTEXT.md
  </success_criteria>

<output>
After completion, create `.planning/phases/03-fueling-records/03-03-SUMMARY.md`
</output>
