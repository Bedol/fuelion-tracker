---
phase: 05-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types/dashboard_types.ts
  - types/index.ts
  - lib/statistics/aggregation.ts
  - pages/api/dashboard.ts
autonomous: true

must_haves:
  truths:
    - 'Dashboard data is available in a single authenticated response for the signed-in user'
    - 'Vehicle summaries include all-time totals and last fueling date'
    - 'Recent activity returns the latest 8 fuelings with vehicle context'
  artifacts:
    - path: 'types/dashboard_types.ts'
      provides: 'Dashboard response and item shapes'
    - path: 'lib/statistics/aggregation.ts'
      provides: 'All-time summary helper for dashboard'
      contains: 'buildAllTime'
    - path: 'pages/api/dashboard.ts'
      provides: 'Authenticated dashboard aggregation endpoint'
      exports: ['default']
  key_links:
    - from: 'pages/api/dashboard.ts'
      to: 'lib/statistics/aggregation.ts'
      via: 'buildAllTime* helper'
      pattern: 'buildAllTime'
    - from: 'pages/api/dashboard.ts'
      to: 'prisma'
      via: 'vehicle and fueling queries scoped to session.user.id'
      pattern: 'getServerSession'
---

<objective>
Build the dashboard aggregation contract and API endpoint.

Purpose: Provide a single, authenticated data source for the dashboard UI.
Output: Dashboard types, all-time summary helper, and `/api/dashboard` endpoint.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard/05-CONTEXT.md
@.planning/phases/05-dashboard/05-RESEARCH.md

@lib/statistics/aggregation.ts
@pages/api/vehicles/[id]/statistics.ts
@types/statistics_types.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dashboard types and all-time summary helper</name>
  <files>types/dashboard_types.ts, types/index.ts, lib/statistics/aggregation.ts</files>
  <action>
Create `types/dashboard_types.ts` with types for:
- `DashboardVehicleSummary` (id, brandName, modelName, registrationNumber, fuelType, currency, totalSpent, averageConsumption, totalDistance, lastFuelingDate)
- `DashboardActivityItem` (vehicleId, vehicleLabel, registrationNumber, date, cost, quantity, mileage)
- `DashboardResponse` ({ vehicles: DashboardVehicleSummary[]; recentActivity: DashboardActivityItem[] })

Export these types from `types/index.ts`.

In `lib/statistics/aggregation.ts`, add a new exported helper (e.g., `buildAllTimeSummary`) that:

- accepts `FuelingInput[]`
- sums all `cost` values for totalSpent
- uses existing `buildIntervals` to compute totalDistance and totalFuel across ALL full-tank intervals
- returns `{ totalSpent, averageConsumption, totalDistance }` with **0 values** when there is no data (aligns with dashboard decision to show zeros)
- does not apply year filtering or monthly windowing
  </action>
  <verify>Run `npm run lint` after completing Task 2.</verify>
  <done>Dashboard types exist and the all-time helper returns numeric totals with zero fallbacks.</done>
  </task>

<task type="auto">
  <name>Task 2: Create the aggregated dashboard API endpoint</name>
  <files>pages/api/dashboard.ts</files>
  <action>
Add `pages/api/dashboard.ts` with a GET handler that:
- uses `getServerSession` + `authOptions`; return 401 when unauthenticated
- queries vehicles for `session.user.id`, ordered by `brand_name` then `model_name`
- fetches all fuelings for those vehicles (select: vehicle_id, date, mileage, quantity, cost, full_tank)
- groups fuelings by vehicle_id and uses `buildAllTimeSummary` to compute totals
- sets `lastFuelingDate` to the most recent fueling date per vehicle (or null when none)
- returns vehicles with summary values and preserves registration number + fuel type + currency
- fetches recent activity as the latest 8 fuelings (orderBy date desc, scoped to the same user) and maps to `DashboardActivityItem`
- returns `{ vehicles, recentActivity }` and empty arrays when the user has no vehicles
- follows the switch-based method pattern with 405 for unsupported methods
  </action>
  <verify>With an authenticated dev session, GET `/api/dashboard` returns 200 with `vehicles` and `recentActivity`; unauthenticated requests return 401.</verify>
  <done>`/api/dashboard` returns a single payload with per-vehicle summaries and the latest 8 activity rows for the signed-in user.</done>
</task>

</tasks>

<verification>
- `npm run lint`
</verification>

<success_criteria>

- Dashboard aggregation types and all-time summary helper exist and are reusable by the UI.
- `/api/dashboard` returns ordered vehicle summaries and recent activity in one authenticated response.
  </success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard/05-01-SUMMARY.md`
</output>
