---
phase: 01-auth-app-shell
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pages/api/auth/[...nextauth].ts
  - pages/auth/signin.tsx
  - pages/index.tsx
autonomous: true

user_setup:
  - service: google-oauth
    why: 'Google OAuth authentication'
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: 'Google Cloud Console -> APIs & Services -> Credentials'
      - name: GOOGLE_CLIENT_SECRET
        source: 'Google Cloud Console -> APIs & Services -> Credentials'
      - name: NEXTAUTH_URL
        source: 'Set to http://localhost:3000 for development, production URL for deployment'
      - name: NEXTAUTH_SECRET
        source: 'Generate with: openssl rand -base64 32'

must_haves:
  truths:
    - 'User can sign in with Google OAuth and session is created'
    - 'User session persists across browser refresh'
    - 'signOut function is available from next-auth/react'
    - 'Unauthenticated users visiting protected routes are redirected to sign-in'
  artifacts:
    - path: 'pages/api/auth/[...nextauth].ts'
      provides: 'NextAuth configuration with custom pages'
      contains: 'pages:'
      exports: ['authOptions']
    - path: 'pages/auth/signin.tsx'
      provides: 'Custom sign-in page with branding'
      contains: 'Fuelion'
      min_lines: 40
  key_links:
    - from: 'pages/api/auth/[...nextauth].ts'
      to: 'pages/auth/signin'
      via: 'custom signIn page config'
      pattern: 'pages:.*signIn.*auth/signin'
---

<objective>
Verify and enhance existing NextAuth Google OAuth implementation by adding custom sign-in page, proper redirect configuration, and exported authOptions for server-side session checks.

Purpose: Complete AUTH-01, AUTH-02, AUTH-03, AUTH-04 requirements. Ensure authentication works correctly with proper session persistence, sign-in/sign-out flows, and route protection foundation.

Output: Production-ready authentication with custom branded sign-in page, persistent sessions, and proper OAuth configuration.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-app-shell/01-CONTEXT.md
@.planning/phases/01-auth-app-shell/01-RESEARCH.md
@pages/api/auth/[...nextauth].ts
@pages/auth/signin.tsx
@pages/_app.tsx
</context>

<tasks>

<task type="auto">
  <name>Enhance NextAuth configuration with custom pages and exported authOptions</name>
  <files>
    pages/api/auth/[...nextauth].ts
  </files>
  <action>
Update NextAuth configuration to add custom sign-in page and export authOptions for server-side use.

Add `pages` configuration to existing NextAuth config:

```typescript
pages: {
  signIn: '/auth/signin',
}
```

Export authOptions as a named export BEFORE the NextAuth() call:

```typescript
export const authOptions = {
  session: { strategy: "jwt" },
  adapter: PrismaAdapter(prisma),
  providers: [...],
  callbacks: {...},
  pages: {
    signIn: '/auth/signin',
  },
};

export default NextAuth(authOptions);
```

This allows importing authOptions in API routes and getServerSideProps for server-side session checks (used in later phases).

Follow research Pattern 1 (NextAuth Session Protection) and code example "NextAuth Configuration (Verify Existing)".

Do NOT modify existing session strategy (jwt), adapter (PrismaAdapter), Google provider config, or session callback. Only add pages config and export authOptions.
</action>
<verify>
Check export exists: `grep "export const authOptions" pages/api/auth/\[...nextauth\].ts`
Check pages config: `grep -A 2 "pages:" pages/api/auth/\[...nextauth\].ts`
Run dev server: `npm run dev` and check logs for NextAuth initialization
</verify>
<done>
authOptions is exported as named export. Custom signIn page is configured at /auth/signin. Existing JWT strategy, Prisma adapter, and callbacks remain unchanged. Dev server starts successfully.
</done>
</task>

<task type="auto">
  <name>Create branded sign-in page with language support</name>
  <files>
    pages/auth/signin.tsx
  </files>
  <action>
Replace existing basic sign-in page with branded, centered design matching context decisions (minimal, functional, no marketing).

Implementation requirements:

- Full viewport centered layout (min-height 100vh, flexbox center)
- Fuelion heading with FaGasPump icon
- Single "Sign in with Google" button with FcGoogle icon
- Use Chakra UI components: Box, Stack, Heading, Button
- Import icons: `import { FaGasPump } from 'react-icons/fa'` and `import { FcGoogle } from 'react-icons/fc'`
- Use i18n for text: `const { t } = useLocale()` with keys "auth.welcome" and "auth.signInWithGoogle"
- Implement auto-redirect: if session exists, redirect to '/' using useEffect
- On sign-in click: `signIn('google', { callbackUrl: '/' })`
- Color scheme: Use blue for heading, white background

Follow research code example "Minimal Sign-In Page" but add i18n support using useLocale hook.

Remove getServerSideProps (not needed, we handle redirect client-side with useEffect).
</action>
<verify>
Check imports: `grep -E "(useLocale|signIn|FcGoogle)" pages/auth/signin.tsx`
Check auto-redirect logic: `grep "useEffect" pages/auth/signin.tsx`
Run dev server: Visit http://localhost:3000/auth/signin and verify page renders with Google sign-in button
</verify>
<done>
Sign-in page displays Fuelion branding, centered layout, Google sign-in button with proper icon, uses i18n translations, and auto-redirects if already signed in. Page is visually complete and functional.
</done>
</task>

<task type="auto">
  <name>Create index page with session check and interim landing</name>
  <files>
    pages/index.tsx
  </files>
  <action>
Create home page that serves as interim landing (Phase 1-4, before Dashboard in Phase 5).

Implementation:

- Use `useSession({ required: true, onUnauthenticated() { router.push('/auth/signin') } })`
- Show loading state while session is loading: `if (status === "loading") return <Loading />`
- Once authenticated, show simple welcome message with user's name
- Include text: "Dashboard coming in Phase 5. For now, use navigation to access Vehicles or Statistics."
- Use Chakra UI: Box, Heading, Text, Stack components
- Use i18n for welcome message: `t('auth.welcome')` and add user name
- Center content vertically and horizontally

This is temporary - will be replaced with real Dashboard in Phase 5. For now, it proves authentication works and provides a landing point.

Follow research "Protected Page Pattern" but simplified (no data fetching yet).
</action>
<verify>
Check session protection: `grep "useSession.*required: true" pages/index.tsx`
Check redirect: `grep "auth/signin" pages/index.tsx`
Run dev server: Visit http://localhost:3000 (should redirect to signin if not authenticated, show welcome if authenticated)
</verify>
<done>
Index page exists with session protection, loading state, and welcome message for authenticated users. Unauthenticated users are redirected to sign-in page. Temporary landing page is functional.
</done>
</task>

</tasks>

<verification>
1. Run `npm run dev` - server starts without errors
2. Visit http://localhost:3000 - should redirect to /auth/signin if not signed in
3. Sign in with Google - should redirect back to / and show welcome message
4. Close browser, reopen, visit site - should still be signed in (session persistence)
5. Check sign-out works: Click sign-out in header - should redirect to sign-in page
6. Check authOptions export: `grep "export const authOptions" pages/api/auth/\[...nextauth\].ts` returns match
</verification>

<success_criteria>

1. Custom sign-in page displays with Fuelion branding and Google sign-in button
2. Sign-in flow redirects to home page (/) after successful authentication
3. Session persists across browser restart (JWT cookie works)
4. Unauthenticated users accessing / are redirected to /auth/signin
5. authOptions is exported for server-side session checks (needed in future phases)
6. Sign-in page uses i18n translations
   </success_criteria>

<output>
After completion, create `.planning/phases/01-auth-app-shell/01-02-SUMMARY.md`
</output>
