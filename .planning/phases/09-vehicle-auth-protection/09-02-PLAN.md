---
phase: 09-vehicle-auth-protection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pages/vehicles/new.tsx
  - pages/vehicles/[id]/edit.tsx
autonomous: true
must_haves:
  truths:
    - "Unauthenticated users visiting vehicle create or edit pages are redirected to /auth/signin"
    - "Vehicle create/edit forms never render before auth is confirmed"
    - "Vehicle edit queries do not run when auth is unresolved"
  artifacts:
    - path: "pages/vehicles/new.tsx"
      provides: "Protected vehicle create page with NextAuth guard"
    - path: "pages/vehicles/[id]/edit.tsx"
      provides: "Protected vehicle edit page with NextAuth guard"
  key_links:
    - from: "pages/vehicles/new.tsx"
      to: "next-auth/react"
      via: "useSession({ required: true, onUnauthenticated })"
      pattern: "useSession\(\{ required: true"
    - from: "pages/vehicles/[id]/edit.tsx"
      to: "next/router"
      via: "router.push('/auth/signin')"
      pattern: "router\.push\('/auth/signin'\)"
---

<objective>
Protect the vehicle create and edit pages with NextAuth so unauthenticated users are redirected before forms or data queries run.

Purpose: Close the AUTH-04 gap on vehicle mutation pages to prevent unauthorized access.
Output: Protected create/edit pages with consistent redirect and loading behavior.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-vehicle-auth-protection/09-RESEARCH.md
@pages/vehicles/new.tsx
@pages/vehicles/[id]/edit.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Require session on vehicle create page</name>
  <files>pages/vehicles/new.tsx</files>
  <action>
    Update useSession to required: true with onUnauthenticated redirect to /auth/signin, matching the dashboard pattern. Render <Loading /> while status === 'loading' and remove the unauthenticated error screen so the redirect is the single behavior. Keep mutation logic intact, relying on session data once authenticated.
  </action>
  <verify>Manual check: visit /vehicles/new while signed out and confirm redirect to /auth/signin without form flash.</verify>
  <done>Vehicle create page redirects unauthenticated users and only renders the form when authenticated.</done>
</task>

<task type="auto">
  <name>Task 2: Require session on vehicle edit page</name>
  <files>pages/vehicles/[id]/edit.tsx</files>
  <action>
    Add useSession with required: true and onUnauthenticated router.push('/auth/signin'). Add a loading guard for status === 'loading'. Gate the vehicle query with enabled: status === 'authenticated' so data only loads after auth is confirmed.
  </action>
  <verify>Manual check: open /vehicles/{id}/edit while signed out and confirm redirect to /auth/signin before data loads.</verify>
  <done>Vehicle edit page does not fetch or render until authenticated and redirects when unauthenticated.</done>
</task>

</tasks>

<verification>
Confirm /vehicles/new and /vehicles/[id]/edit redirect to /auth/signin when unauthenticated and show Loading while auth resolves.
</verification>

<success_criteria>

- Unauthenticated access to create/edit pages redirects to /auth/signin.
- Authenticated users can create or edit vehicles without regression.
  </success_criteria>

<output>
After completion, create `.planning/phases/09-vehicle-auth-protection/09-02-SUMMARY.md`
</output>
