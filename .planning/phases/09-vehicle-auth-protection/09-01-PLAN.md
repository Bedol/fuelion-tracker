---
phase: 09-vehicle-auth-protection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pages/vehicles/index.tsx
  - pages/vehicles/[id]/index.tsx
autonomous: true
must_haves:
  truths:
    - "Unauthenticated users visiting the vehicle list are redirected to /auth/signin"
    - "Unauthenticated users visiting a vehicle detail page are redirected to /auth/signin"
    - "Protected vehicle pages show a loading state while auth resolves"
  artifacts:
    - path: "pages/vehicles/index.tsx"
      provides: "Vehicle list page guarded by NextAuth session"
    - path: "pages/vehicles/[id]/index.tsx"
      provides: "Vehicle detail page guarded by NextAuth session"
  key_links:
    - from: "pages/vehicles/index.tsx"
      to: "next-auth/react"
      via: "useSession({ required: true, onUnauthenticated })"
      pattern: "useSession\(\{ required: true"
    - from: "pages/vehicles/[id]/index.tsx"
      to: "next/router"
      via: "router.push('/auth/signin')"
      pattern: "router\.push\('/auth/signin'\)"
---

<objective>
Guard the vehicle list and detail pages with NextAuth so unauthenticated users are redirected before data loads.

Purpose: Close the AUTH-04 gap on vehicle browsing pages without SSR changes.
Output: Protected list/detail pages that redirect unauthenticated users and avoid pre-auth data fetches.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-vehicle-auth-protection/09-RESEARCH.md
@pages/vehicles/index.tsx
@pages/vehicles/[id]/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NextAuth guard to vehicle list page</name>
  <files>pages/vehicles/index.tsx</files>
  <action>
    Import useSession from next-auth/react and use it with required: true and onUnauthenticated routing to /auth/signin. Reuse the existing router instance for redirects. Render the Loading component while status === 'loading' before any data fetching or UI. Update the vehicles query to only run when status === 'authenticated' to avoid pre-auth requests.
  </action>
  <verify>Manual check: navigate to /vehicles while signed out and confirm redirect to /auth/signin without a data fetch flash.</verify>
  <done>Vehicle list page redirects unauthenticated users and does not fetch vehicles until authenticated.</done>
</task>

<task type="auto">
  <name>Task 2: Add NextAuth guard to vehicle detail page</name>
  <files>pages/vehicles/[id]/index.tsx</files>
  <action>
    Import useSession and apply required: true with onUnauthenticated router.push('/auth/signin'). Add a loading guard that returns <Loading /> when status === 'loading' before running the vehicle query. Gate the vehicle query with enabled: status === 'authenticated' to prevent unauthenticated fetches.
  </action>
  <verify>Manual check: open /vehicles/{id} while signed out and confirm redirect to /auth/signin before content renders.</verify>
  <done>Vehicle detail page is protected by useSession and does not render or fetch before auth resolves.</done>
</task>

</tasks>

<verification>
Confirm /vehicles and /vehicles/[id] both redirect to /auth/signin when unauthenticated and show Loading while auth resolves.
</verification>

<success_criteria>

- Unauthenticated users are redirected to /auth/signin from list and detail pages.
- Authenticated users can load vehicle data with no regressions.
  </success_criteria>

<output>
After completion, create `.planning/phases/09-vehicle-auth-protection/09-01-SUMMARY.md`
</output>
