---
phase: 10-fueling-last-ownership-guard
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified: []
autonomous: false

must_haves:
  truths:
    - 'Authenticated users can only fetch the last fueling for vehicles they own.'
    - 'Requests without a valid session return a 401 error envelope.'
    - 'Requests for non-owned vehicles return a not-found response without leaking existence.'
    - 'Requests missing or invalid vehicleId return 400.'
  artifacts:
    - path: 'pages/api/fueling/last.ts'
      provides: 'Owner-scoped last-fueling endpoint with auth, validation, and guardrails'
      exports: ['default']
  key_links:
    - from: 'pages/api/fueling/last.ts'
      to: 'pages/api/_shared/auth.ts'
      via: 'requireSessionUserId'
      pattern: 'requireSessionUserId'
    - from: 'pages/api/fueling/last.ts'
      to: 'pages/api/_shared/ownership.ts'
      via: 'ensureOwnedVehicle/getOwnedFuelingWhere'
      pattern: 'ensureOwnedVehicle|getOwnedFuelingWhere'
---

<objective>
Verify /api/fueling/last blocks non-owner access.

Purpose: Confirm the ownership guard behaves correctly in real sessions.
Output: Human-verified evidence that unauthorized and non-owned requests are blocked.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@pages/api/fueling/last.ts
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Guarded /api/fueling/last endpoint with session + ownership enforcement.</what-built>
  <how-to-verify>
    1. Run `npm run dev` and sign in as User A; identify a vehicleId that belongs to User A.
    2. In the browser devtools Application tab, copy the session cookie for User A.
    3. Run `curl -i -b "next-auth.session-token=..." "http://localhost:3000/api/fueling/last?vehicleId=<ownedId>"`
       and confirm a 200 response with a fueling payload (or 404 if no fuelings exist).
    4. Sign out and sign in as User B (who does not own User A's vehicle); copy User B's session cookie.
    5. Run the same curl request with User B's cookie and confirm a 404 not-found response.
    6. Run `curl -i "http://localhost:3000/api/fueling/last"` without cookies and confirm a 401 error envelope.
  </how-to-verify>
  <resume-signal>Type "approved" or describe the failure details.</resume-signal>
</task>

</tasks>

<verification>
- Manual curl checks confirm 401 for unauthenticated and 404 for non-owned vehicle.
</verification>

<success_criteria>

- Non-owned vehicle access to /api/fueling/last returns not-found without data leakage.
- Unauthenticated requests return 401 with the standard error envelope.
  </success_criteria>

<output>
After completion, create `.planning/phases/10-fueling-last-ownership-guard/10-02-SUMMARY.md`
</output>
