---
phase: 10-fueling-last-ownership-guard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pages/api/fueling/last.ts
autonomous: true

must_haves:
  truths:
    - "Authenticated users can only fetch the last fueling for vehicles they own."
    - "Requests without a valid session return a 401 error envelope."
    - "Requests for non-owned vehicles return a not-found response without leaking existence."
    - "Requests missing or invalid vehicleId return 400."
  artifacts:
    - path: "pages/api/fueling/last.ts"
      provides: "Owner-scoped last-fueling endpoint with auth, validation, and guardrails"
      exports: ["default"]
    - path: "pages/api/_shared/auth.ts"
      provides: "Session guard for authenticated user id"
    - path: "pages/api/_shared/ownership.ts"
      provides: "Ownership checks and owner-scoped filters"
    - path: "pages/api/_shared/errors.ts"
      provides: "Standard API error envelopes"
  key_links:
    - from: "pages/api/fueling/last.ts"
      to: "pages/api/_shared/auth.ts"
      via: "requireSessionUserId"
      pattern: "requireSessionUserId"
    - from: "pages/api/fueling/last.ts"
      to: "pages/api/_shared/ownership.ts"
      via: "ensureOwnedVehicle/getOwnedFuelingWhere"
      pattern: "ensureOwnedVehicle|getOwnedFuelingWhere"
    - from: "pages/api/fueling/last.ts"
      to: "prisma.fueling.findFirst"
      via: "owner-scoped query ordered by date desc"
      pattern: "findFirst\("
---

<objective>
Scope `/api/fueling/last` to the authenticated vehicle owner.

Purpose: Prevent smart default data from leaking across users.
Output: Guarded last-fueling API response with ownership and validation checks.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-api-ownership-guardrails/06-01-SUMMARY.md
@pages/api/fueling/last.ts
@pages/api/_shared/auth.ts
@pages/api/_shared/ownership.ts
@pages/api/_shared/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session and ownership guardrails to last-fueling lookup</name>
  <files>pages/api/fueling/last.ts</files>
  <action>
    Replace the direct getServerSession check with requireSessionUserId and return early if it fails.
    Add a local parse helper for vehicleId that rejects arrays and non-integers; return 400 with
    { error: 'Invalid vehicle id' } when missing or invalid.
    Call ensureOwnedVehicle(vehicleId, userId) and return a 404 error envelope using sendApiError
    with code NOT_FOUND and message like 'Vehicle not found.' when ownership fails.
    Query prisma.fueling.findFirst with vehicle_id plus getOwnedFuelingWhere(userId), ordered by
    date desc; return a 404 NOT_FOUND envelope when no fueling exists for the owned vehicle.
    Keep GET-only method handling and return the fueling record as JSON on success.
  </action>
  <verify>npm run lint</verify>
  <done>GET /api/fueling/last scopes results to owned vehicles and returns 401/400/404 as specified.</done>
</task>

<task type="auto">
  <name>Task 2: Align imports and response typing with shared error envelopes</name>
  <files>pages/api/fueling/last.ts</files>
  <action>
    Update imports to use requireSessionUserId, ensureOwnedVehicle, getOwnedFuelingWhere, and
    sendApiError from the shared helpers. Remove unused getServerSession/authOptions imports.
    Update NextApiResponse typing to include ApiErrorEnvelope for guardrail error responses.
  </action>
  <verify>npm run lint</verify>
  <done>Endpoint compiles with shared helpers and typed error envelope responses.</done>
</task>

</tasks>

<verification>
- `npm run lint`
</verification>

<success_criteria>

- /api/fueling/last enforces session + vehicle ownership before returning data.
- Missing or invalid vehicleId returns 400, unauthorized returns 401, non-owned returns 404.
- Last fueling selection uses date-desc ordering and ownership scoping.
  </success_criteria>

<output>
After completion, create `.planning/phases/10-fueling-last-ownership-guard/10-01-SUMMARY.md`
</output>
