---
phase: 08-stats-window-and-dod-verification-closure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/statistics/aggregation.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - 'Dashboard vehicle summary shows total distance after fuelings even without full-to-full intervals'
    - 'Average consumption remains derived from full-to-full intervals only'
  artifacts:
    - path: 'lib/statistics/aggregation.ts'
      provides: 'All-time dashboard summary with fallback distance calculation'
      contains: 'buildAllTimeSummary'
  key_links:
    - from: 'pages/api/dashboard.ts'
      to: 'lib/statistics/aggregation.ts'
      via: 'buildAllTimeSummary'
      pattern: 'buildAllTimeSummary'
---

<objective>
Fix dashboard summary totals so total distance reflects fueling mileage deltas even when full-to-full intervals are missing.

Purpose: Close the UIUX-02 verification failure where summary distance stayed at 0 after quick add fuelings.
Output: Updated all-time summary aggregation used by the dashboard API.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-stats-window-and-dod-verification-closure/08-CONTEXT.md
@.planning/phases/08-stats-window-and-dod-verification-closure/08-stats-window-and-dod-verification-closure-VERIFICATION.md
@lib/statistics/aggregation.ts
@pages/api/dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fallback distance calculation for dashboard summaries</name>
  <files>lib/statistics/aggregation.ts</files>
  <action>
In `buildAllTimeSummary`, keep total spent as the sum of all fueling costs.

Compute interval-based totals as today:

- `intervalDistance` from `buildIntervals(fuelings)`
- `intervalFuel` from the same intervals

Add a fallback distance calculation based on all fuelings (not just full tanks):

- sort fuelings by mileage ascending
- sum only positive mileage deltas between consecutive records
- if there are fewer than 2 fuelings, fallback distance is 0

Set `totalDistance` to `intervalDistance` when it is > 0, otherwise use the fallback distance.
Keep `averageConsumption` derived only from interval data (`intervalFuel / intervalDistance * 100`) and return 0 when `intervalDistance` is 0.
</action>
<verify>npm run build</verify>
<done>Total distance is non-zero when any mileage deltas exist, even without full-to-full intervals.</done>
</task>

</tasks>

<verification>
- `npm run build` completes without new TypeScript errors.
</verification>

<success_criteria>

- Dashboard summaries show total distance after fuelings even when only partial or single full fuelings exist.
- Average consumption remains 0 when no full-to-full intervals are available.
  </success_criteria>

<output>
After completion, create `.planning/phases/08-stats-window-and-dod-verification-closure/08-03-SUMMARY.md`.
</output>
