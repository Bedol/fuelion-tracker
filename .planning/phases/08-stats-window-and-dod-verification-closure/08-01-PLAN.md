---
phase: 08-stats-window-and-dod-verification-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/statistics/aggregation.ts
  - types/statistics_types.ts
  - components/statistics/MonthlyCostChart.tsx
  - components/statistics/ChartsSection.tsx
  - pages/vehicles/[id]/statistics.tsx
autonomous: true

must_haves:
  truths:
    - 'Monthly fuel costs chart reflects a rolling 12-month window ending in the current month'
    - 'Current month costs are marked as estimated when data exists'
    - 'Months with no fuelings appear as gaps without misleading labels'
    - 'Chart shows the empty state when no costs exist in the 12-month window'
  artifacts:
    - path: 'lib/statistics/aggregation.ts'
      provides: 'Rolling 12-month monthly cost aggregation with scaling and metadata'
      contains: 'buildMonthlyCosts'
    - path: 'types/statistics_types.ts'
      provides: 'MonthlyCostPoint metadata for empty months and estimates'
      contains: 'MonthlyCostPoint'
    - path: 'components/statistics/MonthlyCostChart.tsx'
      provides: 'Rolling window chart rendering with hidden labels for empty months'
  key_links:
    - from: 'lib/statistics/aggregation.ts'
      to: 'components/statistics/MonthlyCostChart.tsx'
      via: 'monthlyCosts response payload'
      pattern: 'monthlyCosts'
    - from: 'components/statistics/MonthlyCostChart.tsx'
      to: 'components/statistics/ChartsSection.tsx'
      via: 'props'
      pattern: 'MonthlyCostChart'
---

<objective>
Align the monthly fuel costs chart to a rolling 12-month window with clear handling for empty months and an estimated current month.

Purpose: Close STAT-02 behavior gaps while keeping existing consumption/year selection intact.
Output: Updated aggregation logic, response metadata, and chart rendering copy.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-stats-window-and-dod-verification-closure/08-CONTEXT.md
@.planning/phases/08-stats-window-and-dod-verification-closure/08-RESEARCH.md
@lib/statistics/aggregation.ts
@components/statistics/MonthlyCostChart.tsx
@components/statistics/ChartsSection.tsx
@pages/vehicles/[id]/statistics.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace monthly cost aggregation with rolling 12-month window</name>
  <files>lib/statistics/aggregation.ts, types/statistics_types.ts</files>
  <action>
Update `MonthlyCostPoint` to include `hasData: boolean` and optional `isEstimated?: boolean` metadata.

In `lib/statistics/aggregation.ts`, replace year-scoped `buildMonthlyCosts` with a rolling 12-month window anchored to today:

- `windowStart = startOfMonth(addMonths(now, -11))`
- `windowEnd = endOfMonth(now)`
- ignore fuelings outside `[windowStart, windowEnd]` and any `fuelingDate > now`
- compute monthly totals by month key (`MMM yyyy`) in local time
- for the current month only, scale totals by `daysInMonth / daysElapsed` and set `isEstimated = true`
- return 12 points ordered oldest to newest, with `value` set to 0 and `hasData = false` for empty months

Update `buildVehicleStatistics` to call the new monthly cost helper with all fuelings (do not filter by year), and set `hasCostData` via `monthlyCosts.some((point) => point.hasData)`.
Keep year selection and summary logic for consumption and totals unchanged.
</action>
<verify>npm run build</verify>
<done>Monthly cost series returns 12 months with empty-month metadata and a scaled current month when applicable.</done>
</task>

<task type="auto">
  <name>Task 2: Render rolling window chart with gap labels and estimate marker</name>
  <files>components/statistics/MonthlyCostChart.tsx, components/statistics/ChartsSection.tsx, pages/vehicles/[id]/statistics.tsx</files>
  <action>
In `MonthlyCostChart`, use the new metadata to:
- hide X-axis labels for months with `hasData = false` (tick formatter by data index)
- keep empty months in the data so spacing reflects gaps
- update the tooltip to show `0 PLN` for empty months and label the current month as "Estimated" when `isEstimated` is true
- optionally adjust the bar fill/opacity for the estimated month to mark it as in-progress

In `ChartsSection`, update the monthly costs description to reference the rolling 12-month window and note the current month is in progress (without adding helper notes about hidden months).

In `pages/vehicles/[id]/statistics.tsx`, clarify the year selector label (for example, "Consumption year") to avoid implying it controls the rolling monthly costs chart.
</action>
<verify>npm run build</verify>
<done>Monthly cost chart spacing preserves gaps, labels only data months, and shows an estimated current month indicator.</done>
</task>

</tasks>

<verification>
- `npm run build` completes without new TypeScript or runtime errors.
</verification>

<success_criteria>

- Rolling 12-month costs are computed and returned with empty-month metadata and current-month estimation.
- Chart copy and tooltip messaging align with the rolling window and in-progress current month.
- Empty states trigger only when the 12-month window has no cost data.
  </success_criteria>

<output>
After completion, create `.planning/phases/08-stats-window-and-dod-verification-closure/08-01-SUMMARY.md`.
</output>
