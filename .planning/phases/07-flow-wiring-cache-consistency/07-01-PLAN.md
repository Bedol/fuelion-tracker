---
phase: 07-flow-wiring-cache-consistency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pages/api/dashboard.ts
  - components/dashboard/RecentActivityList.tsx
  - hooks/useDashboardData.ts
  - pages/index.tsx
autonomous: true

must_haves:
  truths:
    - 'Dashboard shows the 5 most recent fuelings ordered newest-first'
    - 'Dashboard refresh keeps current data visible and shows a subtle loading indicator'
    - 'Dashboard refresh failures surface as a toast without replacing existing data'
  artifacts:
    - path: 'pages/api/dashboard.ts'
      provides: 'Recent activity query limited to five newest fuelings'
      contains: 'take: 5'
    - path: 'components/dashboard/RecentActivityList.tsx'
      provides: 'Recent activity list limited to five items'
      contains: 'slice(0, 5)'
    - path: 'hooks/useDashboardData.ts'
      provides: 'Dashboard query state for pending vs background refresh'
      exports: ['useDashboardData']
    - path: 'pages/index.tsx'
      provides: 'Dashboard UI with inline refresh indicator and toast-only refresh errors'
      contains: 'isFetching'
  key_links:
    - from: 'hooks/useDashboardData.ts'
      to: 'pages/api/dashboard.ts'
      via: "fetch('/api/dashboard')"
      pattern: '/api/dashboard'
    - from: 'pages/index.tsx'
      to: 'hooks/useDashboardData.ts'
      via: 'useDashboardData query states'
      pattern: 'useDashboardData'
    - from: 'pages/index.tsx'
      to: 'components/ui/toaster.tsx'
      via: 'toaster.create on refresh error'
      pattern: 'toaster.create'
---

<objective>
Refresh dashboard recency and refetch UX so data stays fresh after fueling changes.

Purpose: Keep the dashboard consistent with recent fueling activity without jarring error states.
Output: Updated dashboard query, list rendering, and UI indicators for background refresh.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-flow-wiring-cache-consistency/07-CONTEXT.md

@pages/api/dashboard.ts
@components/dashboard/RecentActivityList.tsx
@hooks/useDashboardData.ts
@pages/index.tsx
@components/ui/toaster.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Limit recent activity to the latest five fuelings</name>
  <files>pages/api/dashboard.ts, components/dashboard/RecentActivityList.tsx</files>
  <action>
Update the dashboard recent activity query to return the newest five fuelings only:
- Keep `orderBy: { date: 'desc' }` in `pages/api/dashboard.ts`
- Change `take` to `5`

Align the UI list to match the new limit:

- Change `visibleItems` to `items.slice(0, 5)` in `components/dashboard/RecentActivityList.tsx`
- Keep the existing item layout (vehicle, date, liters, price, mileage)
  </action>
  <verify>
  Open `pages/api/dashboard.ts` and confirm the recent fuelings query uses `orderBy: { date: 'desc' }` with `take: 5`.
  Open `components/dashboard/RecentActivityList.tsx` and confirm `items.slice(0, 5)` controls the visible list.
  </verify>
  <done>Recent activity shows the five newest fuelings, newest-first.</done>
  </task>

<task type="auto">
  <name>Task 2: Add background refresh indicator and toast-only refresh errors</name>
  <files>hooks/useDashboardData.ts, pages/index.tsx</files>
  <action>
In `pages/index.tsx`, extend the dashboard query handling to support background refresh UX:
- Destructure `isFetching` (and `data`) from `useDashboardData()`.
- Render a subtle inline spinner near the dashboard header when `isFetching && data` (avoid showing during initial load).
- Only render `FetchDataErrorAlert` when `isError && !data` so cached data stays visible on refetch errors.
- Add a `useEffect` with a small guard (e.g., `useRef`) that triggers `toaster.create` when `isError && data` to show a toast like "Failed to refresh dashboard" while keeping the existing UI.

Keep `hooks/useDashboardData.ts` as the single source of query options, but ensure the page can differentiate initial load vs background refresh for the UX above.
</action>
<verify>
Open `pages/index.tsx` and confirm:

- The refresh spinner renders only when `isFetching && data`.
- The error state only blocks the page when `isError && !data`.
- A toast is emitted for refetch errors via `toaster.create` while data remains visible.
  </verify>
  <done>Dashboard refresh shows a subtle spinner, and refetch errors surface via toast without clearing existing data.</done>
  </task>

</tasks>

<verification>
- Manual smoke: run `npm run dev`, create or edit a fueling, return to the dashboard, and confirm a brief refresh spinner plus updated recent activity.
</verification>

<success_criteria>

- Dashboard recent activity is limited to five newest fuelings.
- Background refresh shows a subtle loading indicator without blocking content.
- Refresh failures emit a toast and leave existing data on screen.
  </success_criteria>

<output>
After completion, create `.planning/phases/07-flow-wiring-cache-consistency/07-01-SUMMARY.md`
</output>
