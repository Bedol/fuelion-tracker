---
phase: 04-statistics-&-charts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/statistics/vehicle_stats.ts
  - pages/api/vehicles/[id]/statistics.ts
  - types/statistics_types.ts
autonomous: true

must_haves:
  truths:
    - 'Statistics API returns summary, consumption series, and monthly costs for a vehicle'
    - 'Consumption calculations only use full-tank-to-full-tank intervals'
    - 'API response flags insufficient data instead of returning misleading values'
  artifacts:
    - path: 'lib/statistics/vehicle_stats.ts'
      provides: 'Aggregation helpers for vehicle statistics'
      exports:
        [
          'computeVehicleStatistics',
          'computeMonthlyCosts',
          'computeConsumptionSeries',
        ]
    - path: 'types/statistics_types.ts'
      provides: 'Type definitions for statistics responses'
      exports:
        [
          'VehicleStatisticsResponse',
          'StatisticsSummary',
          'ConsumptionPoint',
          'MonthlyCostPoint',
        ]
    - path: 'pages/api/vehicles/[id]/statistics.ts'
      provides: 'GET endpoint for aggregated statistics'
      exports: ['default']
  key_links:
    - from: 'pages/api/vehicles/[id]/statistics.ts'
      to: 'lib/statistics/vehicle_stats.ts'
      via: 'computeVehicleStatistics()'
      pattern: 'computeVehicleStatistics'
    - from: 'lib/statistics/vehicle_stats.ts'
      to: 'Fueling.full_tank'
      via: 'interval filtering'
      pattern: 'full_tank'
---

<objective>
Create the server-side statistics aggregation and API endpoint for vehicle charts.

Purpose: Centralize full-tank consumption logic and monthly cost aggregation so charts render from a single, trusted API response.
Output: Aggregation helpers, statistics response types, and a protected API endpoint.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-statistics-&-charts/04-RESEARCH.md
@prisma/schema.prisma
@pages/api/fueling/index.ts
@lib/prisma.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add statistics types and aggregation helpers</name>
  <files>types/statistics_types.ts, lib/statistics/vehicle_stats.ts</files>
  <action>
    Create the type definitions and pure aggregation helpers used by the statistics API.

    1. Create `types/statistics_types.ts` with these exported types:
       - `ConsumptionPoint`: { date: string; consumption: number; distance: number; fuelUsed: number; mileage: number }
       - `MonthlyCostPoint`: { month: string; totalCost: number; label: string }
       - `StatisticsSummary`: { totalSpent: number; totalDistance: number; averageConsumption: number | null; totalFuel: number }
       - `VehicleStatisticsResponse`: { vehicle: { id; brand_name; model_name; fuel_type; mileage; currency }; summary; consumptionSeries; monthlyCosts; hasConsumptionData; hasCostData }

    2. Create `lib/statistics/vehicle_stats.ts` with pure functions:
       - `computeConsumptionSeries(fuelings)`:
         - sort by `mileage` ascending
         - accumulate `quantity` between full tanks
         - only create interval when current fueling is `full_tank === true` and distance > 0
         - return points with `date` from interval end fueling (ISO string), `consumption` as (fuelSum / distance) * 100
       - `computeMonthlyCosts(fuelings)`:
         - group by month using `date-fns` `format(date, 'yyyy-MM')`
         - return array sorted by month ascending with `label` formatted as `format(date, 'MMM yyyy')`
       - `computeVehicleStatistics(fuelings)`:
         - build `consumptionSeries` + `monthlyCosts`
         - `totalSpent` = sum of `cost` from all fuelings
         - `totalFuel` = sum of `quantity` from full-tank interval fuelings (the same fuel sum used for intervals)
         - `totalDistance` = sum of distances across valid full-tank intervals
         - `averageConsumption` = totalFuel / totalDistance * 100 if totalDistance > 0 else null
         - return summary + flags `hasConsumptionData` (consumptionSeries.length > 0) and `hasCostData` (monthlyCosts.length > 0)

    Guard against null dates: ignore fuelings without a valid `date` or mileage <= 0.
    Keep helpers framework-agnostic (no Prisma, no Next.js imports).

  </action>
  <verify>npm run lint -- --fix</verify>
  <done>Statistics type definitions and aggregation helpers exist and export the required structures</done>
</task>

<task type="auto">
  <name>Task 2: Implement statistics API endpoint</name>
  <files>pages/api/vehicles/[id]/statistics.ts</files>
  <action>
    Create `pages/api/vehicles/[id]/statistics.ts` with a GET-only handler using the existing switch-method pattern.

    Implementation details:
    - Use `getServerSession` with `authOptions` to require authentication (match fueling API behavior).
    - Validate `id` param as a single value; return 400 for invalid input.
    - Fetch the vehicle by `id` and `user_id` (session.user.id) to enforce ownership; return 404 if not found.
    - Fetch fuelings for the vehicle with fields: id, date, mileage, quantity, cost, full_tank.
    - Pass fuelings to `computeVehicleStatistics` and return a `VehicleStatisticsResponse` payload:
      { vehicle: { id, brand_name, model_name, fuel_type, mileage, currency }, summary, consumptionSeries, monthlyCosts, hasConsumptionData, hasCostData }.

    Use `res.status(200).json(...)` for success and set `Allow: ['GET']` for unsupported methods.

  </action>
  <verify>curl -s /api/vehicles/1/statistics | jq '.summary'</verify>
  <done>GET /api/vehicles/:id/statistics returns aggregated stats for an authenticated vehicle</done>
</task>

</tasks>

<verification>
After completion:
1. Request `/api/vehicles/{id}/statistics` and verify summary + chart arrays exist
2. Confirm consumptionSeries only includes full-tank intervals
3. Confirm monthlyCosts groups by month and has labels
</verification>

<success_criteria>

- Aggregation helpers exist and are reusable by the API
- Statistics API is session-protected and returns consistent response shape
- Insufficient data yields `hasConsumptionData: false` and `averageConsumption: null`
  </success_criteria>

<output>
After completion, create `.planning/phases/04-statistics-&-charts/04-01-SUMMARY.md`
</output>
