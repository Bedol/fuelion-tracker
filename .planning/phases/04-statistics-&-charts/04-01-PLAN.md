---
phase: 04-statistics-&-charts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types/statistics_types.ts
  - types/index.ts
  - lib/statistics/aggregation.ts
  - pages/api/vehicles/[id]/statistics.ts
autonomous: true

must_haves:
  truths:
    - 'Statistics API returns summary totals and chart series for a vehicle'
    - 'Consumption series uses only full-tank intervals and skips invalid distances'
    - 'Monthly costs cover the last 12 months and omit zero months'
    - 'API returns not-enough-data flags when no valid intervals exist'
  artifacts:
    - path: 'types/statistics_types.ts'
      provides: 'Typed response for vehicle statistics'
      exports: ['VehicleStatisticsResponse', 'StatisticsSummary']
      min_lines: 20
    - path: 'lib/statistics/aggregation.ts'
      provides: 'Pure aggregation helpers for consumption and costs'
      exports: ['buildVehicleStatistics']
      min_lines: 120
    - path: 'pages/api/vehicles/[id]/statistics.ts'
      provides: 'Vehicle statistics API endpoint'
      exports: ['default handler']
      min_lines: 80
      routes:
        - 'GET /api/vehicles/[id]/statistics'
  key_links:
    - from: 'pages/api/vehicles/[id]/statistics.ts'
      to: 'prisma.fueling.findMany'
      via: 'Prisma client'
      pattern: 'prisma.fueling.findMany'
    - from: 'pages/api/vehicles/[id]/statistics.ts'
      to: 'lib/statistics/aggregation.ts'
      via: 'buildVehicleStatistics'
      pattern: 'buildVehicleStatistics'
    - from: 'lib/statistics/aggregation.ts'
      to: 'fueling.full_tank'
      via: 'interval calculation'
      pattern: 'full_tank'
---

<objective>
Create server-side statistics aggregation and an API endpoint for vehicle statistics.

Purpose: The statistics API is the foundation for charts and summary numbers. It must compute accurate consumption using full-tank intervals and provide clean monthly aggregations for the UI.

Output: Pure aggregation helpers, typed response definitions, and a REST API endpoint at `/api/vehicles/[id]/statistics`.
</objective>

<execution_context>
@/home/bweber/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/bweber/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-statistics-&-charts/04-CONTEXT.md
@.planning/phases/04-statistics-&-charts/04-RESEARCH.md
@pages/api/fueling/index.ts
@types/fueling_types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add statistics types and aggregation helpers</name>
  <files>types/statistics_types.ts, types/index.ts, lib/statistics/aggregation.ts</files>
  <action>
    Create a typed statistics response and pure aggregation helpers.

    **types/statistics_types.ts**
    - Define types for summary and chart points:
      - `StatisticsSummary` with `totalSpent`, `averageConsumption`, `totalDistance`
      - `ConsumptionPoint` with `month`, `value`
      - `MonthlyCostPoint` with `month`, `value`
      - `VehicleStatisticsResponse` with `summary`, `consumption`, `monthlyCosts`,
        `hasConsumptionData`, `hasCostData`
    - Use numbers for values, and allow `averageConsumption` and `totalDistance` to be `null` when no valid intervals.
    - Export all types and re-export via `types/index.ts`.

    **lib/statistics/aggregation.ts**
    - Implement pure helpers that accept an array of fuelings with fields:
      `{ date, mileage, quantity, cost, full_tank }`.
    - Steps:
      1. Sort fuelings by `mileage` ascending.
      2. Build full-tank intervals by summing `quantity` between full-tank entries.
         - Only compute consumption when there are two consecutive `full_tank` entries.
         - Skip intervals with `distance <= 0`.
      3. For each interval, compute `consumption = (fuelSum / distance) * 100`.
      4. Group interval consumption by month (use date-fns `format` with `MMM yyyy`).
         - Monthly consumption point is the **average** of intervals in that month.
      5. Group monthly costs from all fuelings by month (format `MMM yyyy`).
         - Use a rolling 12-month window and omit months with zero cost.
      6. Summary:
         - `totalSpent` = sum of all fueling costs.
         - `totalDistance` = sum of valid interval distances.
         - `averageConsumption` = (totalFuel / totalDistance) * 100; set `null` if no valid intervals.
    - Export a single function `buildVehicleStatistics(fuelings)` returning `VehicleStatisticsResponse`.
    - Use `new Date(fueling.date)` before formatting to keep date parsing consistent.
    - Avoid any Prisma or Next.js imports in helpers.

  </action>
  <verify>ls -la lib/statistics types/statistics_types.ts</verify>
  <done>Statistics types exist and aggregation helpers return monthly series plus summary totals</done>
</task>

<task type="auto">
  <name>Task 2: Create vehicle statistics API endpoint</name>
  <files>pages/api/vehicles/[id]/statistics.ts</files>
  <action>
    Implement `GET /api/vehicles/[id]/statistics` using Prisma and the aggregation helper.

    Requirements:
    - Use `getServerSession(req, res, authOptions)` and return 401 if missing session.
    - Parse `id` from `req.query` and validate it is a number; return 400 on invalid.
    - Fetch fuelings for the vehicle with Prisma:
      - Select fields: `date`, `mileage`, `quantity`, `cost`, `full_tank`.
      - Order by `date: 'asc'` (aggregation helper will re-sort by mileage).
    - Call `buildVehicleStatistics(fuelings)` and return JSON.
    - Always return 200 with a consistent response shape, even if empty.
    - Use switch statement for method handling and return 405 for non-GET.

  </action>
  <verify>ls -la pages/api/vehicles/[id]/statistics.ts</verify>
  <done>Statistics API returns a typed payload with summary, consumption series, and monthly costs</done>
</task>

</tasks>

<verification>
1. Confirm statistics API returns summary and two series for a vehicle.
2. Verify consumption uses only full-tank intervals and skips invalid distances.
3. Verify monthly costs cover the last 12 months and omit zero months.
</verification>

<success_criteria>

- `lib/statistics/aggregation.ts` computes full-tank intervals, monthly averages, and summary totals
- `types/statistics_types.ts` defines the response contract used by API and UI
- `pages/api/vehicles/[id]/statistics.ts` returns consistent statistics payloads with auth checks
  </success_criteria>

<output>
After completion, create `.planning/phases/04-statistics-&-charts/04-01-SUMMARY.md`
</output>
